<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Video - Barrios A2I</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        .progress-shimmer {
            background: linear-gradient(90deg, #0891b2 0%, #14b8a6 50%, #0891b2 100%);
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
        }
        .field-indicator {
            transition: all 0.3s ease;
        }
        .field-indicator.filled {
            color: #06b6d4;
        }
        .field-indicator.filled .dot {
            background: #06b6d4;
        }
        .message-enter {
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .phase-item {
            transition: all 0.3s ease;
        }
        .phase-item.current {
            background: rgba(6, 182, 212, 0.2);
            border: 1px solid rgba(6, 182, 212, 0.5);
        }
        .phase-item.complete {
            background: rgba(34, 197, 94, 0.1);
        }
    </style>
</head>
<body class="bg-gradient-to-b from-gray-950 to-black min-h-screen text-white">
    <!-- Header -->
    <header class="border-b border-gray-800 bg-gray-950/50 backdrop-blur-sm">
        <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
            <a href="/" class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-cyan-500 to-teal-600 rounded-lg flex items-center justify-center">
                    <span class="text-white font-bold">B</span>
                </div>
                <span class="text-xl font-bold text-white">Barrios A2I</span>
            </a>
            <span class="text-cyan-400 text-sm">Creative Director AI</span>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-6xl mx-auto px-4 py-8">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold mb-2">Create Your Video</h1>
            <p class="text-gray-400">Tell me about your business and I'll create a professional video for you</p>
        </div>

        <!-- Chat Container -->
        <div class="bg-gray-900/80 border border-cyan-500/30 rounded-xl overflow-hidden">
            <!-- Progress Bar Section -->
            <div id="progress-section" class="p-4 border-b border-gray-800">
                <div class="space-y-3">
                    <!-- Progress bar -->
                    <div class="relative h-2 bg-gray-800 rounded-full overflow-hidden">
                        <div id="progress-bar" class="absolute left-0 top-0 h-full bg-cyan-500 transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <!-- Field indicators -->
                    <div class="flex justify-between text-xs">
                        <div class="field-indicator flex items-center gap-1 text-gray-500" data-field="business_name">
                            <span class="dot w-2 h-2 rounded-full bg-gray-600"></span>
                            <span>Business</span>
                        </div>
                        <div class="field-indicator flex items-center gap-1 text-gray-500" data-field="primary_offering">
                            <span class="dot w-2 h-2 rounded-full bg-gray-600"></span>
                            <span>Product</span>
                        </div>
                        <div class="field-indicator flex items-center gap-1 text-gray-500" data-field="target_demographic">
                            <span class="dot w-2 h-2 rounded-full bg-gray-600"></span>
                            <span>Audience</span>
                        </div>
                        <div class="field-indicator flex items-center gap-1 text-gray-500" data-field="call_to_action">
                            <span class="dot w-2 h-2 rounded-full bg-gray-600"></span>
                            <span>CTA</span>
                        </div>
                        <div class="field-indicator flex items-center gap-1 text-gray-500" data-field="tone">
                            <span class="dot w-2 h-2 rounded-full bg-gray-600"></span>
                            <span>Tone</span>
                        </div>
                    </div>
                    <!-- Status text -->
                    <div id="progress-status" class="text-center text-sm text-gray-400">
                        0% complete ‚Ä¢ Describe your business to get started
                    </div>
                </div>
            </div>

            <!-- Main chat area -->
            <div class="flex gap-4 p-4" style="height: 500px;">
                <!-- Chat messages -->
                <div class="flex-1 flex flex-col">
                    <div id="messages" class="flex-1 overflow-y-auto space-y-4 pr-2">
                        <!-- Welcome message -->
                        <div class="flex justify-start">
                            <div class="max-w-[80%] p-3 rounded-lg bg-gray-800 text-gray-100 message-enter">
                                üëã Hey! I'm your Creative Director. Tell me about your business and what kind of video you're looking for. You can give me all the details at once, or we can chat through it step by step.
                            </div>
                        </div>
                    </div>

                    <!-- Input area -->
                    <form id="chat-form" class="mt-4 flex gap-2">
                        <input
                            type="text"
                            id="message-input"
                            placeholder="Describe your video..."
                            class="flex-1 bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:border-cyan-500"
                        >
                        <button
                            type="submit"
                            id="send-btn"
                            class="px-6 py-3 bg-cyan-600 hover:bg-cyan-500 disabled:bg-gray-700 disabled:cursor-not-allowed rounded-lg font-semibold text-white transition-colors"
                        >
                            Send
                        </button>
                    </form>
                </div>

                <!-- Side panel -->
                <div id="side-panel" class="w-80 space-y-4 hidden">
                    <!-- Brief Summary Card -->
                    <div id="brief-summary" class="bg-gray-800/50 border border-cyan-500/30 rounded-lg p-4 space-y-4">
                        <h3 class="text-cyan-400 font-semibold text-lg flex items-center gap-2">
                            üìã Video Brief
                        </h3>
                        <div id="brief-fields" class="space-y-2">
                            <!-- Fields populated by JS -->
                        </div>
                        <button
                            id="start-production-btn"
                            class="w-full py-3 bg-gradient-to-r from-cyan-600 to-teal-600 hover:from-cyan-500 hover:to-teal-500 rounded-lg font-semibold text-white transition-all hidden"
                        >
                            üé¨ Start Video Production
                        </button>
                    </div>

                    <!-- Production Monitor -->
                    <div id="production-monitor" class="bg-gray-800/50 border border-cyan-500/30 rounded-lg p-4 space-y-4 hidden">
                        <div class="flex items-center justify-between">
                            <h3 class="text-cyan-400 font-semibold text-lg flex items-center gap-2">
                                <span class="animate-pulse">üé¨</span> RAGNAROK Production
                            </h3>
                            <span id="production-progress" class="text-cyan-300 font-mono">0%</span>
                        </div>
                        <div class="h-3 bg-gray-700 rounded-full overflow-hidden">
                            <div id="production-bar" class="h-full bg-gradient-to-r from-cyan-500 to-teal-500 transition-all duration-500" style="width: 0%"></div>
                        </div>
                        <div id="phase-list" class="space-y-2">
                            <!-- Phases populated by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tips -->
        <div class="mt-8 grid md:grid-cols-3 gap-4">
            <div class="bg-gray-900/50 border border-gray-800 rounded-lg p-4">
                <div class="text-2xl mb-2">üí°</div>
                <h3 class="font-semibold mb-1">Quick Start</h3>
                <p class="text-gray-400 text-sm">Give me all details at once:<br>"TechStart, SaaS tools, founders, sign up, professional"</p>
            </div>
            <div class="bg-gray-900/50 border border-gray-800 rounded-lg p-4">
                <div class="text-2xl mb-2">üéØ</div>
                <h3 class="font-semibold mb-1">5 Things I Need</h3>
                <p class="text-gray-400 text-sm">Business name, product/service, target audience, call-to-action, tone</p>
            </div>
            <div class="bg-gray-900/50 border border-gray-800 rounded-lg p-4">
                <div class="text-2xl mb-2">‚ö°</div>
                <h3 class="font-semibold mb-1">AI-Powered</h3>
                <p class="text-gray-400 text-sm">RAGNAROK v7.0 generates your video in ~4 minutes with 97.5% quality rate</p>
            </div>
        </div>
    </main>

    <script>
        // Configuration
        const GENESIS_URL = 'https://barrios-genesis-flawless.onrender.com';
        const SESSION_ID = `session-${Date.now()}`;

        // State
        let conversationHistory = [];
        let briefState = {
            progress: 0,
            missingFields: ['business_name', 'primary_offering', 'target_demographic', 'call_to_action', 'tone'],
            extractedData: {},
            isComplete: false,
            triggerProduction: false
        };
        let isLoading = false;
        let eventSource = null;

        // DOM Elements
        const messagesEl = document.getElementById('messages');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const chatForm = document.getElementById('chat-form');
        const progressBar = document.getElementById('progress-bar');
        const progressStatus = document.getElementById('progress-status');
        const sidePanel = document.getElementById('side-panel');
        const briefSummary = document.getElementById('brief-summary');
        const briefFields = document.getElementById('brief-fields');
        const startProductionBtn = document.getElementById('start-production-btn');
        const productionMonitor = document.getElementById('production-monitor');
        const productionProgress = document.getElementById('production-progress');
        const productionBar = document.getElementById('production-bar');
        const phaseList = document.getElementById('phase-list');

        // RAGNAROK Phases
        const PHASES = [
            { id: 'intake', label: 'Brief Analysis', icon: 'üìã' },
            { id: 'intelligence', label: 'Market Intelligence', icon: 'üîç' },
            { id: 'story', label: 'Story Generation', icon: 'üìù' },
            { id: 'prompts', label: 'Visual Prompts', icon: 'üé®' },
            { id: 'video', label: 'Video Generation', icon: 'üé¨' },
            { id: 'voice', label: 'Voice Synthesis', icon: 'üéôÔ∏è' },
            { id: 'music', label: 'Music Selection', icon: 'üéµ' },
            { id: 'assembly', label: 'Final Assembly', icon: 'üîß' },
            { id: 'qa', label: 'Quality Check', icon: '‚úÖ' }
        ];

        // Field labels
        const FIELD_LABELS = {
            business_name: { label: 'Business', icon: 'üè¢' },
            primary_offering: { label: 'Product/Service', icon: 'üì¶' },
            target_demographic: { label: 'Target Audience', icon: 'üë•' },
            call_to_action: { label: 'Call to Action', icon: 'üéØ' },
            tone: { label: 'Tone', icon: 'üé®' }
        };

        // Add message to chat
        function addMessage(role, content) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            msgDiv.innerHTML = `
                <div class="max-w-[80%] p-3 rounded-lg ${
                    role === 'user'
                        ? 'bg-cyan-600 text-white'
                        : 'bg-gray-800 text-gray-100'
                } message-enter">
                    ${escapeHtml(content)}
                </div>
            `;
            messagesEl.appendChild(msgDiv);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Update progress UI
        function updateProgressUI() {
            // Update progress bar
            progressBar.style.width = `${briefState.progress}%`;
            if (briefState.isComplete) {
                progressBar.classList.add('bg-green-500');
                progressBar.classList.remove('bg-cyan-500');
            }

            // Update field indicators
            document.querySelectorAll('.field-indicator').forEach(el => {
                const field = el.dataset.field;
                if (!briefState.missingFields.includes(field)) {
                    el.classList.add('filled');
                } else {
                    el.classList.remove('filled');
                }
            });

            // Update status text
            if (briefState.isComplete) {
                progressStatus.innerHTML = '<span class="text-green-400">‚úì Brief complete - Ready for production</span>';
            } else {
                const missing = briefState.missingFields
                    .map(f => FIELD_LABELS[f]?.label || f)
                    .join(', ');
                progressStatus.textContent = `${briefState.progress}% complete ‚Ä¢ Need: ${missing || 'Nothing'}`;
            }

            // Show/hide side panel
            if (briefState.progress > 0) {
                sidePanel.classList.remove('hidden');
                updateBriefSummary();
            }

            // Show/hide production button
            if (briefState.isComplete) {
                startProductionBtn.classList.remove('hidden');
            }
        }

        // Update brief summary card
        function updateBriefSummary() {
            briefFields.innerHTML = Object.entries(FIELD_LABELS).map(([key, { label, icon }]) => {
                const value = briefState.extractedData[key];
                return `
                    <div class="flex items-center justify-between p-2 bg-gray-900/50 rounded">
                        <div class="flex items-center gap-2">
                            <span>${icon}</span>
                            <span class="text-gray-400 text-sm">${label}:</span>
                        </div>
                        <span class="text-sm ${value ? 'text-white' : 'text-gray-500 italic'}">
                            ${escapeHtml(value || 'Not provided')}
                        </span>
                    </div>
                `;
            }).join('');
        }

        // Send message to API
        async function sendMessage(message) {
            if (isLoading || !message.trim()) return;

            isLoading = true;
            sendBtn.disabled = true;
            messageInput.disabled = true;

            // Add user message
            addMessage('user', message);
            conversationHistory.push({ role: 'user', content: message });

            // Add loading indicator
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-msg';
            loadingDiv.className = 'flex justify-start';
            loadingDiv.innerHTML = `
                <div class="bg-gray-800 text-gray-400 p-3 rounded-lg animate-pulse">
                    Thinking...
                </div>
            `;
            messagesEl.appendChild(loadingDiv);
            messagesEl.scrollTop = messagesEl.scrollHeight;

            try {
                const response = await fetch(`${GENESIS_URL}/api/genesis/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: SESSION_ID,
                        message: message,
                        conversation_history: conversationHistory.slice(0, -1)
                    })
                });

                if (!response.ok) throw new Error(`API error: ${response.status}`);

                const data = await response.json();

                // Remove loading indicator
                document.getElementById('loading-msg')?.remove();

                // Add assistant response
                addMessage('assistant', data.response);
                conversationHistory.push({ role: 'assistant', content: data.response });

                // Update brief state
                briefState.progress = data.progress_percentage || 0;
                briefState.missingFields = data.missing_fields || [];
                briefState.extractedData = { ...briefState.extractedData, ...data.extracted_data };
                briefState.isComplete = data.is_complete || false;
                briefState.triggerProduction = data.trigger_production || false;

                updateProgressUI();

                // Auto-start production if triggered
                if (briefState.triggerProduction) {
                    startProduction();
                }

            } catch (error) {
                document.getElementById('loading-msg')?.remove();
                addMessage('assistant', `‚ùå Error: ${error.message}. Please try again.`);
            } finally {
                isLoading = false;
                sendBtn.disabled = false;
                messageInput.disabled = false;
                messageInput.focus();
            }
        }

        // Initialize phase list for production monitor
        function initPhaseList() {
            phaseList.innerHTML = PHASES.map(({ id, label, icon }) => `
                <div class="phase-item flex items-center gap-3 p-2 rounded bg-gray-900/30" data-phase="${id}">
                    <span class="text-lg">${icon}</span>
                    <span class="flex-1 text-gray-500">${label}</span>
                    <span class="status-icon"></span>
                </div>
            `).join('');
        }

        // Start production with SSE
        function startProduction() {
            briefSummary.classList.add('hidden');
            productionMonitor.classList.remove('hidden');
            initPhaseList();

            // Connect to SSE
            eventSource = new EventSource(`${GENESIS_URL}/api/production/status/${SESSION_ID}/stream`);

            eventSource.addEventListener('status', (event) => {
                try {
                    const data = JSON.parse(event.data);

                    // Update overall progress
                    if (data.overall_progress !== undefined) {
                        productionProgress.textContent = `${data.overall_progress}%`;
                        productionBar.style.width = `${data.overall_progress}%`;
                    }

                    // Update phase status
                    if (data.phase) {
                        document.querySelectorAll('.phase-item').forEach(el => {
                            el.classList.remove('current');
                        });

                        const phaseEl = document.querySelector(`[data-phase="${data.phase}"]`);
                        if (phaseEl) {
                            const statusIcon = phaseEl.querySelector('.status-icon');
                            const phaseText = phaseEl.querySelector('.flex-1');

                            if (data.status === 'complete') {
                                phaseEl.classList.add('complete');
                                phaseText.classList.remove('text-gray-500', 'text-cyan-300');
                                phaseText.classList.add('text-green-400');
                                statusIcon.textContent = '‚úì';
                                statusIcon.className = 'status-icon text-green-500';
                            } else {
                                phaseEl.classList.add('current');
                                phaseText.classList.remove('text-gray-500');
                                phaseText.classList.add('text-cyan-300');
                                statusIcon.textContent = `${data.progress || 0}%`;
                                statusIcon.className = 'status-icon text-cyan-400 text-sm animate-pulse';
                            }
                        }
                    }

                    // Check for completion
                    if (data.status === 'complete' && data.phase === 'qa') {
                        eventSource.close();
                        addMessage('assistant', 'üéâ Your video is ready! Production complete.');
                    }
                } catch (e) {
                    console.error('SSE parse error:', e);
                }
            });

            eventSource.addEventListener('error', () => {
                console.error('SSE connection error - attempting reconnect');
            });
        }

        // Event listeners
        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const message = messageInput.value.trim();
            if (message) {
                messageInput.value = '';
                sendMessage(message);
            }
        });

        startProductionBtn.addEventListener('click', () => {
            sendMessage('Yes, start production!');
        });

        // Initialize
        messageInput.focus();
    </script>
</body>
</html>
